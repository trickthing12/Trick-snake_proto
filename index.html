<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>랜덤 맵 스네이크</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #e6ffd2 0, #c7f0a6 40%, #a8d58b 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #374151;
      padding: 16px;
    }

    .layout {
      display: flex;
      width: 100%;
      max-width: 960px;
      gap: 16px;
    }

    /* 좌측 메뉴: 정보 / 보상 */
    .sidebar {
      width: 72px;
      background: rgba(255,255,255,0.4);
      border-radius: 24px;
      padding: 12px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      box-shadow: 0 4px 10px rgba(86,124,75,0.35);
    }

    .sidebar-title {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 4px;
    }

    .menu-circle {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      background: #fef3c7;
      border: 2px solid #facc15;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #92400e;
      text-align: center;
      cursor: pointer;
    }

    .menu-circle.secondary {
      background: #dcfce7;
      border-color: #4ade80;
      color: #166534;
    }

    .card-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .card {
      width: 100%;
      max-width: 720px;
      background: #fdfaf2;
      border-radius: 32px;
      border: 3px solid #9fdb7c;
      box-shadow:
        0 14px 30px rgba(46, 96, 40, 0.35),
        inset 0 0 0 1px rgba(255, 255, 255, 0.75);
      padding: 18px 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      position: relative;
      overflow: hidden;
    }

    /* 상단 제목 중앙 정렬 */
    .card-header {
      display: flex;
      justify-content: center;
      text-align: center;
      margin-bottom: 4px;
      position: relative;
    }

    .title-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
    }

    .title-main {
      font-size: 20px;
      font-weight: 700;
      color: #374151;
    }

    .title-sub {
      font-size: 13px;
      color: #6b7280;
    }

    /* 상단 좌측 일시 정지 버튼 */
    .pause-btn {
      position: absolute;
      left: 0;
      top: 0;
      transform: translateY(-2px);
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: none;
      background: #dcfce7;
      border: 2px solid #22c55e;
      color: #166534;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pause-btn:active {
      transform: translateY(0);
      filter: brightness(0.96);
    }

    /* 메인 게임 영역 */
    .card-content {
      display: flex;
      justify-content: center;
    }

    .game-column {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .canvas-wrapper {
      background: #d9f99d;
      border-radius: 24px;
      border: 2px solid #a3e635;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 520px;
    }

    canvas {
      border-radius: 18px;
      border: 2px solid #6ee7b7;
      background: #020617;
      touch-action: none;
      max-width: 100%;
      height: auto;
      display: block;
    }

    /* 캔버스 하단 레이아웃 */
    .under-game {
      width: 100%;
      max-width: 520px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
    }

    /* 좌측: 큰 게임 시작 버튼 + 패드 */
    .left-controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .big-start-btn {
      width: 170px;
      height: 64px;
      border-radius: 22px;
      border: none;
      background: linear-gradient(90deg,#4ade80,#22c55e);
      color: #064e3b;
      font-size: 18px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 5px 0 rgba(22,163,74,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .big-start-btn:active {
      transform: translateY(1px);
      box-shadow: 0 3px 0 rgba(22,163,74,0.95);
      filter: brightness(0.97);
    }

    #controls {
      user-select: none;
    }

    .pad-shell {
      background: #fef3c7;
      border-radius: 20px;
      border: 2px solid #facc15;
      padding: 6px 10px 8px;
      box-shadow: 0 4px 0 rgba(202,138,4,0.6);
    }

    .row {
      display: flex;
      gap: 6px;
      justify-content: center;
    }

    .btn {
      width: 54px;
      height: 54px;
      border-radius: 18px;
      border: none;
      background: #fde68a;
      color: #92400e;
      font-size: 20px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn:active {
      transform: translateY(1px);
      filter: brightness(0.95);
    }

    /* 우측: 다시 시작 + 점수/상태 (2배 정도 크게) */
    .restart-stack {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
      flex: 0 0 auto;
    }

    #restartBtn {
      padding: 14px 26px;
      border-radius: 20px;
      border: none;
      background: linear-gradient(90deg,#fb923c,#f97316);
      color: #fefce8;
      font-size: 16px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 5px 0 rgba(180,83,9,0.8);
      white-space: nowrap;
    }
    #restartBtn:active {
      transform: translateY(1px);
      box-shadow: 0 3px 0 rgba(180,83,9,0.9);
      filter: brightness(0.96);
    }

    #info {
      font-size: 14px;
      color: #374151;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
    }

    #info span {
      margin-right: 2px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 15px;
      background: #f9fafb;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      font-size: 15px;
      color: #4b5563;
      gap: 6px;
    }

    @media (max-width: 768px) {
      .layout {
        flex-direction: column;
        align-items: center;
      }
      .sidebar {
        flex-direction: row;
        width: auto;
        padding: 8px 12px;
      }
      .control-row {
        flex-direction: column;
        align-items: center;
      }
      .restart-stack {
        align-items: center;
      }
      #info {
        justify-content: center;
      }
    }

    @media (max-width: 600px) {
      canvas {
        width: 320px;
        height: 320px;
      }
      .btn {
        width: 48px;
        height: 48px;
      }
    }

    /* 전체 오버레이 (초기 게임 시작용) */
    .overlay {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .overlay-inner {
      background: #fefce8;
      border-radius: 24px;
      padding: 24px 28px 22px;
      box-shadow: 0 14px 30px rgba(30,64,175,0.4);
      text-align: center;
      max-width: 360px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }

    .overlay-title {
      font-size: 20px;
      font-weight: 700;
      color: #374151;
    }

    .overlay-sub {
      font-size: 13px;
      color: #6b7280;
    }

    .overlay-start-btn {
      margin-top: 6px;
      width: 200px;
      height: 64px;
      border-radius: 22px;
      border: none;
      background: linear-gradient(90deg,#4ade80,#22c55e);
      color: #064e3b;
      font-size: 18px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 5px 0 rgba(22,163,74,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .overlay-start-btn:active {
      transform: translateY(1px);
      box-shadow: 0 3px 0 rgba(22,163,74,0.95);
      filter: brightness(0.97);
    }

    /* 정보/보상 모달 */
    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 11;
    }

    .modal {
      background: #fefce8;
      border-radius: 20px;
      padding: 18px 20px 16px;
      box-shadow: 0 14px 30px rgba(30,64,175,0.35);
      max-width: 420px;
      width: 100%;
      font-size: 13px;
      color: #4b5563;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 700;
      color: #374151;
    }

    .modal-close {
      align-self: flex-end;
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      background: #dcfce7;
      color: #166534;
      font-size: 12px;
      cursor: pointer;
      margin-top: 4px;
    }
    .modal-close:active {
      transform: translateY(1px);
      filter: brightness(0.96);
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- 좌측 메뉴: 정보 / 보상 -->
    <aside class="sidebar">
      <div class="sidebar-title">메뉴</div>
      <div class="menu-circle" id="infoMenu">정보</div>
      <div class="menu-circle secondary" id="rewardMenu">보상</div>
    </aside>

    <!-- 중앙 카드 -->
    <main class="card-wrapper">
      <section class="card">
        <!-- 일시 정지 버튼 -->
        <button type="button" class="pause-btn" id="pauseBtn">Ⅱ</button>

        <header class="card-header">
          <div class="title-group">
            <div class="title-main">랜덤 맵 스네이크</div>
            <div class="title-sub">장애물이 섞인 맵에서 뱀을 조작해 생존해 보세요.</div>
          </div>
        </header>

        <div class="card-content">
          <div class="game-column">
            <div class="canvas-wrapper">
              <!-- 캔버스 크기: 480×480 -->
              <canvas id="game" width="480" height="480"></canvas>
            </div>

            <div class="under-game">
              <div class="control-row">
                <!-- 좌측: 큰 게임 시작 버튼 + 방향키 -->
                <div class="left-controls">
                  <button id="startBtnBottom" class="big-start-btn">게임 시작</button>
                  <div id="controls">
                    <div class="pad-shell">
                      <div class="row">
                        <button class="btn" data-dir="up">▲</button>
                      </div>
                      <div class="row" style="margin-top:4px;">
                        <button class="btn" data-dir="left">◀</button>
                        <button class="btn" data-dir="down">▼</button>
                        <button class="btn" data-dir="right">▶</button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 우측: 다시 시작 + 점수/상태 -->
                <div class="restart-stack">
                  <button id="restartBtn">다시 시작</button>
                  <div id="info">
                    <span class="badge">
                      점수 <strong id="score">0</strong>
                    </span>
                    <span class="badge">
                      상태 <span id="status">대기 중</span>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 초기 게임 시작 오버레이 -->
        <div class="overlay" id="startOverlay">
          <div class="overlay-inner">
            <div class="overlay-title">랜덤 맵 스네이크</div>
            <div class="overlay-sub">
              화면 중앙의 버튼을 눌러 게임을 시작하세요.<br />
              PC: 방향키 · WASD, 모바일: 하단 가상 패드
            </div>
            <button id="startBtnMain" class="overlay-start-btn">게임 시작</button>
          </div>
        </div>

        <!-- 정보 모달 -->
        <div class="modal-backdrop" id="infoModal">
          <div class="modal">
            <div class="modal-title">게임 정보</div>
            <div>
              1. 방향키 또는 하단 가상 패드로 뱀의 이동 방향을 조작합니다.<br />
              2. 맵은 게임을 시작할 때마다 랜덤으로 생성되며, 장애물 배치도 함께 랜덤입니다.<br />
              3. 벽, 장애물, 자신의 몸에 부딪히면 게임 오버가 됩니다.<br />
              4. 먹이를 먹을 때마다 점수가 올라가고, 뱀의 몸이 한 칸씩 길어집니다.<br />
              5. 일시 정지 상태에서는 뱀이 움직이지 않습니다.
            </div>
            <button class="modal-close" data-close-modal="infoModal">닫기</button>
          </div>
        </div>

        <!-- 보상 모달 -->
        <div class="modal-backdrop" id="rewardModal">
          <div class="modal">
            <div class="modal-title">보상 정보</div>
            <div>
              - 점수에 따라 가상의 코인 · 재료 등 다양한 보상을 받는 구조를 가정한 예시입니다.<br />
              - 높은 점수를 기록할수록 더 상위 등급의 보상을 얻는 방향으로 확장할 수 있습니다.<br />
              - 실제 게임 기획에서는 점수 구간별 보상 테이블을 설계해 사용할 수 있습니다.
            </div>
            <button class="modal-close" data-close-modal="rewardModal">닫기</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== 기본 설정 및 상태 =====
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const statusEl = document.getElementById('status');
    const restartBtn = document.getElementById('restartBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const startOverlay = document.getElementById('startOverlay');
    const startBtnMain = document.getElementById('startBtnMain');
    const startBtnBottom = document.getElementById('startBtnBottom');
    const infoMenu = document.getElementById('infoMenu');
    const rewardMenu = document.getElementById('rewardMenu');
    const infoModal = document.getElementById('infoModal');
    const rewardModal = document.getElementById('rewardModal');

    const GRID_SIZE = 20;
    const TILE_SIZE = canvas.width / GRID_SIZE; // 480 / 20 = 24px
    // 기존보다 0.75배 느리게: 140 / 0.75 ≈ 187 → 약 190ms
    const INITIAL_SPEED = 190;
    const OBSTACLE_COUNT = 35;

    let snake, direction, nextDirection, food, obstacles;
    let gameInterval = null;
    let isGameOver = false;
    let isPaused = false;
    let hasStarted = false; // 최소 1회 이상 게임을 시작했는지
    let score = 0;

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function posEquals(a, b) {
      return a.x === b.x && a.y === b.y;
    }

    function isOutOfBounds(pos) {
      return pos.x < 0 || pos.x >= GRID_SIZE || pos.y < 0 || pos.y >= GRID_SIZE;
    }

    function cellOccupied(pos) {
      for (const s of snake || []) {
        if (posEquals(s, pos)) return true;
      }
      for (const o of obstacles || []) {
        if (posEquals(o, pos)) return true;
      }
      return false;
    }

    function initGame() {
      const startX = Math.floor(GRID_SIZE / 2);
      const startY = Math.floor(GRID_SIZE / 2);
      snake = [
        { x: startX - 1, y: startY },
        { x: startX,     y: startY },
        { x: startX + 1, y: startY },
      ];
      direction = { x: 1, y: 0 };
      nextDirection = { x: 1, y: 0 };
      score = 0;
      isGameOver = false;
      isPaused = false;
      scoreEl.textContent = score;
      statusEl.textContent = '플레이 중';

      obstacles = [];
      let attempts = 0;
      while (obstacles.length < OBSTACLE_COUNT && attempts < OBSTACLE_COUNT * 30) {
        attempts++;
        const pos = { x: randInt(0, GRID_SIZE - 1), y: randInt(0, GRID_SIZE - 1) };
        if (cellOccupied(pos)) continue;
        const distFromStart = Math.abs(pos.x - startX) + Math.abs(pos.y - startY);
        if (distFromStart < 4) continue;
        obstacles.push(pos);
      }

      spawnFood();
      draw(); // 초기 프레임
    }

    function spawnFood() {
      let pos;
      do {
        pos = { x: randInt(0, GRID_SIZE - 1), y: randInt(0, GRID_SIZE - 1) };
      } while (cellOccupied(pos));
      food = pos;
    }

    // ===== 게임 시작 / 재시작 =====
    function startNewGame() {
      initGame();
      hasStarted = true;
      isPaused = false;
      updatePauseButton();
      if (gameInterval) clearInterval(gameInterval);
      gameInterval = setInterval(gameLoop, INITIAL_SPEED);
      hideStartOverlay();
    }

    function hideStartOverlay() {
      startOverlay.style.display = 'none';
    }

    function showStartOverlay() {
      startOverlay.style.display = 'flex';
      statusEl.textContent = '대기 중';
    }

    // ===== 일시 정지 버튼 상태 반영 =====
    function updatePauseButton() {
      // 일시 정지면 ▶, 아니면 Ⅱ
      pauseBtn.textContent = isPaused ? '▶' : 'Ⅱ';
    }

    // ===== 입력 처리 =====
    function setDirection(dir) {
      if (!hasStarted || isGameOver) return;

      if (dir === 'up' && direction.y !== 1) {
        nextDirection = { x: 0, y: -1 };
      } else if (dir === 'down' && direction.y !== -1) {
        nextDirection = { x: 0, y: 1 };
      } else if (dir === 'left' && direction.x !== 1) {
        nextDirection = { x: -1, y: 0 };
      } else if (dir === 'right' && direction.x !== -1) {
        nextDirection = { x: 1, y: 0 };
      }
    }

    window.addEventListener('keydown', (e) => {
      const key = e.key;
      if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(key)) {
        e.preventDefault();
      }
      if (key === 'ArrowUp' || key === 'w' || key === 'W') setDirection('up');
      if (key === 'ArrowDown' || key === 's' || key === 'S') setDirection('down');
      if (key === 'ArrowLeft' || key === 'a' || key === 'A') setDirection('left');
      if (key === 'ArrowRight' || key === 'd' || key === 'D') setDirection('right');

      if (key === ' ' && isGameOver) {
        startNewGame();
      }
    });

    const controlButtons = document.querySelectorAll('.btn');
    controlButtons.forEach(btn => {
      const dir = btn.getAttribute('data-dir');
      const handler = (e) => {
        e.preventDefault();
        setDirection(dir);
      };
      btn.addEventListener('click', handler);
      btn.addEventListener('touchstart', handler, { passive: false });
    });

    // 하단 큰 게임 시작 버튼 & 중앙 오버레이 버튼 → 동일 로직
    startBtnMain.addEventListener('click', () => startNewGame());
    startBtnBottom.addEventListener('click', () => startNewGame());
    restartBtn.addEventListener('click', () => startNewGame());

    // 일시 정지 버튼
    pauseBtn.addEventListener('click', () => {
      if (!hasStarted || isGameOver) return;
      isPaused = !isPaused;
      updatePauseButton();
      statusEl.textContent = isPaused ? '일시 정지' : '플레이 중';
    });

    // ===== 사이드 메뉴 모달 (정보/보상) =====
    function anyModalOpen() {
      return infoModal.style.display === 'flex' || rewardModal.style.display === 'flex';
    }

    function openModal(modal) {
      modal.style.display = 'flex';
      if (hasStarted && !isGameOver) {
        isPaused = true;
        updatePauseButton();
        statusEl.textContent = '일시 정지 (메뉴 열림)';
      }
    }

    function closeModal(modal) {
      modal.style.display = 'none';
      if (!anyModalOpen() && hasStarted && !isGameOver) {
        isPaused = false;
        updatePauseButton();
        statusEl.textContent = '플레이 중';
      }
    }

    infoMenu.addEventListener('click', () => openModal(infoModal));
    rewardMenu.addEventListener('click', () => openModal(rewardModal));

    document.querySelectorAll('.modal-close').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-close-modal');
        const modal = document.getElementById(id);
        if (modal) closeModal(modal);
      });
    });

    // ===== 게임 루프 =====
    function gameLoop() {
      if (isGameOver || isPaused || !hasStarted) return;

      direction = nextDirection;
      const head = snake[snake.length - 1];
      const newHead = { x: head.x + direction.x, y: head.y + direction.y };

      if (isOutOfBounds(newHead)) {
        endGame('벽에 부딪힘');
        return;
      }
      for (const o of obstacles) {
        if (posEquals(o, newHead)) {
          endGame('장애물에 부딪힘');
          return;
        }
      }
      for (const s of snake) {
        if (posEquals(s, newHead)) {
          endGame('몸에 부딪힘');
          return;
        }
      }

      snake.push(newHead);

      if (posEquals(newHead, food)) {
        score += 10;
        scoreEl.textContent = score;
        spawnFood();
      } else {
        snake.shift();
      }

      draw();
    }

    function endGame(reason) {
      isGameOver = true;
      statusEl.textContent = '게임 오버 - ' + reason;
      if (gameInterval) clearInterval(gameInterval);
      isPaused = false;
      updatePauseButton();
    }

    // ===== 렌더링 =====
    function draw() {
      ctx.fillStyle = '#020617';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.strokeStyle = '#111827';
      ctx.lineWidth = 1;
      for (let i = 0; i <= GRID_SIZE; i++) {
        const p = i * TILE_SIZE;
        ctx.beginPath();
        ctx.moveTo(p, 0);
        ctx.lineTo(p, canvas.height);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(0, p);
        ctx.lineTo(canvas.width, p);
        ctx.stroke();
      }

      ctx.fillStyle = '#4b5563';
      obstacles.forEach(o => {
        ctx.fillRect(o.x * TILE_SIZE, o.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
      });

      ctx.fillStyle = '#f97316';
      ctx.fillRect(food.x * TILE_SIZE, food.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);

      snake.forEach((s, idx) => {
        if (idx === snake.length - 1) {
          ctx.fillStyle = '#22c55e';
        } else {
          ctx.fillStyle = '#16a34a';
        }
        ctx.fillRect(s.x * TILE_SIZE, s.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
      });
    }

    // 최초에는 오버레이만 띄워두고, 캔버스는 비워둔다.
    showStartOverlay();
    updatePauseButton();
  </script>
</body>
</html>
