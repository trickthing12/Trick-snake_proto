<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>랜덤 맵 스네이크 게임</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #050711;
      color: #f5f5f5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 16px;
      gap: 12px;
    }
    h1 {
      font-size: 20px;
      margin-top: 4px;
    }
    #game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    canvas {
      border: 2px solid #444;
      background: #111827;
      touch-action: none;
    }
    #info {
      font-size: 14px;
    }
    #info span {
      margin-right: 8px;
    }
    #controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 8px;
      gap: 4px;
      user-select: none;
    }
    .row {
      display: flex;
      gap: 4px;
    }
    .btn {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      border: none;
      background: #1f2937;
      color: #f9fafb;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn:active {
      transform: translateY(1px);
      filter: brightness(0.9);
    }

    #restartBtn {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: #f9fafb;
      font-size: 14px;
      cursor: pointer;
      margin-left: 6px;
    }
    #restartBtn:active {
      transform: translateY(1px);
      filter: brightness(0.9);
    }

    /* 모바일일 때 가상 패드 여백 확보 */
    @media (max-width: 600px) {
      canvas {
        width: 320px;
        height: 320px;
      }
    }
  </style>
</head>
<body>
  <h1>랜덤 맵 스네이크</h1>
  <div id="game-container">
    <canvas id="game" width="400" height="400"></canvas>
    <div id="info">
      <span>점수: <span id="score">0</span></span>
      <span>상태: <span id="status">플레이 중</span></span>
      <button id="restartBtn">다시 시작</button>
    </div>
  </div>

  <!-- 모바일 가상 패드 -->
  <div id="controls">
    <div class="row">
      <button class="btn" data-dir="up">▲</button>
    </div>
    <div class="row">
      <button class="btn" data-dir="left">◀</button>
      <button class="btn" data-dir="down">▼</button>
      <button class="btn" data-dir="right">▶</button>
    </div>
  </div>

  <script>
    // ===== 기본 설정 =====
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const statusEl = document.getElementById('status');
    const restartBtn = document.getElementById('restartBtn');

    const GRID_SIZE = 20;             // 20 × 20 타일
    const TILE_SIZE = canvas.width / GRID_SIZE; // 400 / 20 = 20px
    const INITIAL_SPEED = 140;        // 밀리초 (틱 간격)
    const OBSTACLE_COUNT = 35;        // 장애물 개수

    let snake, direction, nextDirection, food, obstacles;
    let gameInterval = null;
    let isGameOver = false;
    let score = 0;

    // ===== 유틸 =====
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function posEquals(a, b) {
      return a.x === b.x && a.y === b.y;
    }

    function isOutOfBounds(pos) {
      return pos.x < 0 || pos.x >= GRID_SIZE || pos.y < 0 || pos.y >= GRID_SIZE;
    }

    function cellOccupied(pos) {
      // 뱀 또는 장애물에 이미 있는지 확인
      for (const s of snake) {
        if (posEquals(s, pos)) return true;
      }
      for (const o of obstacles) {
        if (posEquals(o, pos)) return true;
      }
      return false;
    }

    // ===== 초기화 & 재시작 =====
    function initGame() {
      const startX = Math.floor(GRID_SIZE / 2);
      const startY = Math.floor(GRID_SIZE / 2);
      snake = [
        { x: startX - 1, y: startY },
        { x: startX,     y: startY },
        { x: startX + 1, y: startY },
      ];
      direction = { x: 1, y: 0 };
      nextDirection = { x: 1, y: 0 };
      score = 0;
      isGameOver = false;
      scoreEl.textContent = score;
      statusEl.textContent = '플레이 중';

      // 장애물 생성
      obstacles = [];
      let attempts = 0;
      while (obstacles.length < OBSTACLE_COUNT && attempts < OBSTACLE_COUNT * 30) {
        attempts++;
        const pos = { x: randInt(0, GRID_SIZE - 1), y: randInt(0, GRID_SIZE - 1) };
        if (cellOccupied(pos)) continue;
        // 시작 위치 주변은 너무 막히지 않도록 제한 (원한다면 조정 가능)
        const distFromStart = Math.abs(pos.x - startX) + Math.abs(pos.y - startY);
        if (distFromStart < 4) continue;
        obstacles.push(pos);
      }

      // 먹이 생성
      spawnFood();

      // 루프 시작
      if (gameInterval) clearInterval(gameInterval);
      gameInterval = setInterval(gameLoop, INITIAL_SPEED);
      draw();
    }

    function spawnFood() {
      let pos;
      do {
        pos = { x: randInt(0, GRID_SIZE - 1), y: randInt(0, GRID_SIZE - 1) };
      } while (cellOccupied(pos));
      food = pos;
    }

    // ===== 입력 처리 =====
    function setDirection(dir) {
      // 역방향으로 바로 꺾지 않도록 제한
      if (dir === 'up' && direction.y !== 1) {
        nextDirection = { x: 0, y: -1 };
      } else if (dir === 'down' && direction.y !== -1) {
        nextDirection = { x: 0, y: 1 };
      } else if (dir === 'left' && direction.x !== 1) {
        nextDirection = { x: -1, y: 0 };
      } else if (dir === 'right' && direction.x !== -1) {
        nextDirection = { x: 1, y: 0 };
      }
    }

    window.addEventListener('keydown', (e) => {
      const key = e.key;
      if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(key)) {
        e.preventDefault(); // 스크롤 방지
      }
      if (key === 'ArrowUp' || key === 'w' || key === 'W') setDirection('up');
      if (key === 'ArrowDown' || key === 's' || key === 'S') setDirection('down');
      if (key === 'ArrowLeft' || key === 'a' || key === 'A') setDirection('left');
      if (key === 'ArrowRight' || key === 'd' || key === 'D') setDirection('right');

      if (key === ' ' && isGameOver) {
        initGame();
      }
    });

    // 모바일/데스크탑 공용 가상 패드
    const controlButtons = document.querySelectorAll('.btn');
    controlButtons.forEach(btn => {
      const dir = btn.getAttribute('data-dir');
      const handler = (e) => {
        e.preventDefault();
        setDirection(dir);
      };
      btn.addEventListener('click', handler);
      btn.addEventListener('touchstart', handler, { passive: false });
    });

    restartBtn.addEventListener('click', () => initGame());

    // ===== 게임 루프 =====
    function gameLoop() {
      if (isGameOver) return;

      direction = nextDirection;
      const head = snake[snake.length - 1];
      const newHead = { x: head.x + direction.x, y: head.y + direction.y };

      // 벽 충돌
      if (isOutOfBounds(newHead)) {
        endGame('벽에 부딪힘');
        return;
      }
      // 장애물 충돌
      for (const o of obstacles) {
        if (posEquals(o, newHead)) {
          endGame('장애물에 부딪힘');
          return;
        }
      }
      // 자기 몸 충돌
      for (const s of snake) {
        if (posEquals(s, newHead)) {
          endGame('몸에 부딪힘');
          return;
        }
      }

      // 머리 추가
      snake.push(newHead);

      // 먹이 먹음
      if (posEquals(newHead, food)) {
        score += 10;
        scoreEl.textContent = score;
        spawnFood();
        // 꼬리 제거하지 않음 → 길이 증가
      } else {
        // 이동: 꼬리 제거
        snake.shift();
      }

      draw();
    }

    function endGame(reason) {
      isGameOver = true;
      statusEl.textContent = '게임 오버 - ' + reason;
      if (gameInterval) clearInterval(gameInterval);
    }

    // ===== 렌더링 =====
    function draw() {
      // 배경
      ctx.fillStyle = '#020617';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // 그리드 (선택 사항 – 연출용)
      ctx.strokeStyle = '#111827';
      ctx.lineWidth = 1;
      for (let i = 0; i <= GRID_SIZE; i++) {
        const p = i * TILE_SIZE;
        ctx.beginPath();
        ctx.moveTo(p, 0);
        ctx.lineTo(p, canvas.height);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(0, p);
        ctx.lineTo(canvas.width, p);
        ctx.stroke();
      }

      // 장애물
      ctx.fillStyle = '#4b5563';
      obstacles.forEach(o => {
        ctx.fillRect(o.x * TILE_SIZE, o.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
      });

      // 먹이
      ctx.fillStyle = '#f97316';
      ctx.fillRect(food.x * TILE_SIZE, food.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);

      // 뱀
      snake.forEach((s, idx) => {
        if (idx === snake.length - 1) {
          ctx.fillStyle = '#22c55e'; // 머리
        } else {
          ctx.fillStyle = '#16a34a'; // 몸통
        }
        ctx.fillRect(s.x * TILE_SIZE, s.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
      });
    }

    // 초기 시작
    initGame();
  </script>
</body>
</html>

